<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPE aaS Ready Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --hpe-green: #01A982;
            --hpe-dark-green: #008567;
            --hpe-gray: #425563;
            --hpe-light-gray: #F5F5F5;
            --hpe-border: #E0E0E0;
            --text-primary: #333;
            --text-secondary: #666;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #F9F9F9;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: linear-gradient(135deg, var(--hpe-green) 0%, var(--hpe-dark-green) 100%);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
        }

        .header-right {
            text-align: right;
        }

        .last-updated {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid var(--hpe-green);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--hpe-green);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-card h3 {
            color: var(--hpe-gray);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-wide {
            grid-column: span 2;
        }

        .status-disclaimer {
            background-color: #FFF9E6;
            border-left: 4px solid #FFA07A;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #5D4E37;
            line-height: 1.5;
        }

        .status-disclaimer strong {
            color: #E65100;
            font-weight: 600;
        }

        .insights-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .insights-section h3 {
            color: var(--hpe-gray);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .insights-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .insight-card {
            padding: 1rem;
            border-left: 4px solid var(--hpe-green);
            background-color: #F9F9F9;
            border-radius: 4px;
        }

        .insight-card.positive {
            border-left-color: #01A982;
            background-color: #E8F5F1;
        }

        .insight-card.negative {
            border-left-color: #FF6B6B;
            background-color: #FFF3F3;
        }

        .insight-card.neutral {
            border-left-color: #45B7D1;
            background-color: #F0F8FF;
        }

        .insight-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--hpe-gray);
            margin-bottom: 0.5rem;
        }

        .insight-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--hpe-green);
            margin-bottom: 0.5rem;
        }

        .insight-value.negative {
            color: #FF6B6B;
        }

        .insight-description {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #555;
        }

        .insight-list {
            margin-top: 0.75rem;
            padding-left: 1.25rem;
        }

        .insight-list li {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .narrative-box {
            grid-column: 1 / -1;
            padding: 1.25rem;
            background: linear-gradient(135deg, #E8F5F1 0%, #F0F8FF 100%);
            border-radius: 8px;
            border: 2px solid var(--hpe-green);
        }

        .narrative-box h4 {
            color: var(--hpe-green);
            font-size: 1rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .narrative-box p {
            font-size: 0.9rem;
            line-height: 1.7;
            color: #333;
            margin-bottom: 0.75rem;
        }

        .table-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .table-header h2 {
            color: var(--hpe-gray);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            color: var(--text-secondary);
        }

        #searchInput {
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 1px solid var(--hpe-border);
            border-radius: 4px;
            font-size: 0.9rem;
            width: 300px;
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--hpe-green);
        }

        .filter-tags {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--hpe-green);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }

        .filter-toggle-btn:hover {
            background: var(--hpe-dark-green);
        }

        .filter-arrow {
            transition: transform 0.3s;
            font-size: 0.8rem;
        }

        .filter-arrow.expanded {
            transform: rotate(90deg);
        }

        .filter-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
        }

        .filter-content.expanded {
            max-height: 500px;
            opacity: 1;
        }

        .filter-tag {
            padding: 0.5rem 1rem;
            background-color: var(--hpe-light-gray);
            border: 1px solid var(--hpe-border);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tag:hover {
            background-color: var(--hpe-green);
            color: white;
            border-color: var(--hpe-green);
        }

        .filter-tag.active {
            background-color: var(--hpe-green);
            color: white;
            border-color: var(--hpe-green);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        thead {
            background-color: var(--hpe-light-gray);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 0.6rem 0.4rem;
            text-align: left;
            font-weight: 600;
            color: var(--hpe-gray);
            border-bottom: 2px solid var(--hpe-border);
            white-space: nowrap;
            font-size: 0.75rem;
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background-color: #E8F5F1;
        }

        th.sortable {
            padding-right: 1.5rem;
        }

        .sort-indicator {
            position: absolute;
            right: 0.3rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.65rem;
            color: var(--hpe-green);
        }

        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            background-color: transparent;
        }

        .resize-handle:hover,
        .resize-handle.active {
            background-color: var(--hpe-green);
        }

        th.resizing {
            user-select: none;
        }

        td {
            padding: 0.5rem 0.4rem;
            border-bottom: 1px solid var(--hpe-border);
            font-size: 0.75rem;
        }

        .ssid-cell {
            min-width: 80px;
            white-space: nowrap;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
            color: white;
        }

        .status-completed { background-color: #01A982; }
        .status-ontrack { background-color: #4ECDC4; }
        .status-started { background-color: #FFA07A; }
        .status-notstarted { background-color: #FF6B6B; }
        .status-onhold { background-color: #425563; }
        .status-na { background-color: #45B7D1; }

        .tier-badge {
            display: inline-block;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            background-color: var(--hpe-green);
            color: white;
        }

        .program-name {
            max-width: 300px;
        }

        .program-name.expandable {
            cursor: pointer;
            color: var(--hpe-green);
            transition: color 0.2s;
            font-size: 0.75rem;
        }

        .program-name.expandable:hover {
            color: var(--hpe-dark-green);
        }

        .expand-icon {
            display: inline-block;
            font-size: 0.6rem;
            margin-right: 0.25rem;
            transition: transform 0.2s;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .detail-row {
            background-color: #F9F9F9;
        }

        .detail-cell {
            padding: 1rem !important;
        }

        .detail-content {
            max-width: 100%;
            line-height: 1.5;
            font-size: 0.75rem;
        }

        .detail-description, .detail-milestones {
            margin-top: 0.5rem;
            padding: 0.6rem;
            background-color: white;
            border-left: 3px solid var(--hpe-green);
            white-space: pre-wrap;
            font-size: 0.75rem;
        }

        .link-cell {
            max-width: 300px;
            font-size: 0.7rem;
        }

        .link-cell a {
            color: var(--hpe-green);
            text-decoration: none;
            font-weight: 400;
            word-break: break-word;
            display: block;
            font-size: 0.7rem;
        }

        .link-cell a:hover {
            text-decoration: underline;
            color: var(--hpe-dark-green);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .error {
            background-color: #FFF3F3;
            border-left: 4px solid #FF6B6B;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            color: #C62828;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-right {
                text-align: center;
                margin-top: 1rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-wide {
                grid-column: span 1;
            }

            .search-box {
                width: 100%;
            }

            #searchInput {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>HPE aaS Ready (aka GreenLake READY)</h1>
                    <p>GL Ready Process Standardization Tracking</p>
                </div>
                <div class="header-right">
                    <div class="last-updated">Last Updated: <span id="lastUpdated">Loading...</span></div>
                    <div class="last-updated">Data Source: Smartsheet</div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading">
            <h3>Loading data from Smartsheet...</h3>
            <p>Please wait while we fetch the latest program information.</p>
        </div>

        <!-- Error Container -->
        <div id="errorContainer" style="display: none;"></div>

        <!-- Dashboard Content (hidden until loaded) -->
        <div id="dashboardContent" style="display: none;">
            <!-- Metrics -->
            <div class="metrics-grid" id="metricsGrid">
                <!-- Dynamically populated -->
            </div>

            <!-- Charts Row 1 -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Programs by GL Ready Adoption Status</h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Programs by Business Unit</h3>
                    <div class="chart-container">
                        <canvas id="buChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Average Duration by BU</h3>
                    <div class="chart-container">
                        <canvas id="timeToMarketChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Programs by Tier</h3>
                    <div class="chart-container">
                        <canvas id="tierChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Programs by Template</h3>
                    <div class="chart-container">
                        <canvas id="templateChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Milestone Timeline Analysis</h3>
                    <div class="chart-container">
                        <canvas id="milestoneChart"></canvas>
                    </div>
                    <div style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-secondary); text-align: center;">
                        Average days between key milestones - based on programs with milestone data
                    </div>
                </div>
            </div>

            <!-- Charts Row 3 - Trend Analysis -->
            <div class="charts-grid">
                <div class="chart-card chart-wide">
                    <h3>Time to Market Trend Analysis - GL Ready Process Impact</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                    <div style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-secondary); text-align: center;">
                        Quarterly average program duration - demonstrating standardization effectiveness
                    </div>
                </div>
            </div>

            <!-- Trend Insights Panel -->
            <div class="insights-section">
                <h3>Trend Insights & Analysis</h3>
                <div id="trendInsights" class="insights-content">
                    <!-- Dynamically populated by JavaScript -->
                </div>
            </div>

            <!-- Programs Table -->
            <div class="table-section">
                <div class="table-header">
                    <h2>Programs Overview</h2>
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="searchInput" placeholder="Search programs...">
                    </div>
                </div>
                
                <div class="status-disclaimer">
                    <strong>Note:</strong> Adoption reflects GL Ready Process status, not overall program status. For program delivery status, refer to HC PMO teams in each BU.
                </div>
                
                <button class="filter-toggle-btn" id="filterToggleBtn">
                    <span class="filter-arrow">‚ñ∂</span>
                    <span>Filters</span>
                </button>
                
                <div class="filter-content" id="filterContent">
                    <div class="filter-tags" id="filterTags"></div>
                </div>

                <div class="table-container">
                    <table id="programsTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="ssID" data-type="text">
                                    ssID
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="sortable" data-column="bu" data-type="text">
                                    Business Unit
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="sortable" data-column="itemName" data-type="text">
                                    Program Name
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="sortable" data-column="tier" data-type="text">
                                    Tier
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="sortable" data-column="template" data-type="text">
                                    Template
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="sortable" data-column="nsi" data-type="number">
                                    HPE Service NSI
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="sortable" data-column="productManager" data-type="text">
                                    Product Manager
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="sortable" data-column="programManager" data-type="text">
                                    Program Manager
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="sortable" data-column="e2eLead" data-type="text">
                                    E2E Lead
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                                <th data-column="projectPlan">
                                    Project Plan Link
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="sortable" data-column="status" data-type="text">
                                    Adoption
                                    <span class="sort-indicator"></span>
                                    <div class="resize-handle"></div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="programsTableBody">
                            <!-- Dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION - CHOOSE YOUR PROXY
        // ============================================================
        
        // FOR LOCAL TESTING:
        // 1. Run: node smartsheet-proxy.js (in separate terminal)
        // 2. Use this URL:
        const PROXY_URL_LOCAL = 'http://localhost:3000/api/sheet';
        
        // FOR PRODUCTION (Azure Function):
        // 1. Create Azure Function (see QUICK_START_SHAREPOINT.md)
        // 2. Paste your Function URL here:
        const PROXY_URL_AZURE = 'https://dashboard-proxy-2-hra6dvchbmgdbdez.westus2-01.azurewebsites.net/api/HttpTrigger1?code=B_WrXYZ4e54NwnSHmJYqj9BNS_Niqfw1BogM2vRBj83DAzFuwriK3w==';
        
        // CURRENT SETTING: Switch between 'local' and 'azure'
        const USE_PROXY = 'azure';  // Change to 'azure' for production
        
        // Auto-select proxy URL based on setting
        const PROXY_URL = USE_PROXY === 'local' ? PROXY_URL_LOCAL : PROXY_URL_AZURE;
        
        // ============================================================
        // END CONFIGURATION
        // ============================================================

        // Global variables
        let allPrograms = [];
        let filteredPrograms = [];
        let currentStatusFilter = 'all';
        let currentBUFilter = 'all';
        let currentSort = { column: null, direction: 'asc' };
        const charts = {};

        // Fetch data from Smartsheet via proxy
        async function fetchSmartsheetData() {
            try {
                console.log('Fetching from proxy:', PROXY_URL);
                console.log('Using proxy mode:', USE_PROXY);
                
                // Simple GET request - no custom headers for better CORS compatibility
                const response = await fetch(PROXY_URL, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error(`Proxy error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Data received from proxy');
                return parseSmartsheetData(data);
            } catch (error) {
                console.error('Error fetching Smartsheet data:', error);
                throw error;
            }
        }

        // Parse Smartsheet response into our data structure
        function parseSmartsheetData(smartsheetData) {
            // Build column map: column title -> column ID
            const columnMap = {};
            smartsheetData.columns.forEach(col => {
                columnMap[col.title] = col.id;
            });

            // Expected column names (adjust these if your Smartsheet has different column names)
            const expectedColumns = {
                ssID: 'ssID',
                status: 'GL Ready Adoption Status',
                bu: 'BU (Source - BU Dashboard)',
                itemName: 'Item Name',
                tier: 'Program Tier',
                template: 'Template',
                startDate: 'Program Start Date',
                finishDate: 'Program Finish Date',
                description: 'Program Description',
                milestones: 'Milestones',
                nsi: 'HPE Service NSI (#/link)',
                productManager: 'Product Manager',
                programManager: 'Program Manager',
                e2eLead: 'E2E Lead',
                projectPlan: 'Project Plan Link'
            };

            // Parse rows
            const programs = [];
            smartsheetData.rows.forEach(row => {
                const program = {};
                
                // Map each cell to our data structure
                row.cells.forEach(cell => {
                    // Find which column this cell belongs to
                    const column = smartsheetData.columns.find(col => col.id === cell.columnId);
                    if (!column) return;

                    const columnTitle = column.title;
                    
                    // Map to our expected fields
                    if (columnTitle === expectedColumns.ssID) {
                        program.ssID = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.status) {
                        program.status = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.bu) {
                        program.bu = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.itemName) {
                        program.itemName = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.tier) {
                        program.tier = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.template) {
                        program.template = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.startDate) {
                        program.startDate = cell.value || '';
                    } else if (columnTitle === expectedColumns.finishDate) {
                        program.finishDate = cell.value || '';
                    } else if (columnTitle === expectedColumns.description) {
                        program.description = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.milestones) {
                        program.milestones = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.nsi) {
                        program.nsi = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.productManager) {
                        program.productManager = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.programManager) {
                        program.programManager = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.e2eLead) {
                        program.e2eLead = cell.displayValue || cell.value || '';
                    } else if (columnTitle === expectedColumns.projectPlan) {
                        // Check if cell has a hyperlink
                        if (cell.hyperlink && cell.hyperlink.url) {
                            program.projectPlanUrl = cell.hyperlink.url;
                            program.projectPlanText = cell.displayValue || cell.value || cell.hyperlink.url;
                        } else {
                            program.projectPlanUrl = cell.displayValue || cell.value || '';
                            program.projectPlanText = cell.displayValue || cell.value || '';
                        }
                    }
                });

                programs.push(program);
            });

            return programs;
        }

        // Validate ssID
        function hasValidSSID(program) {
            const ssID = program.ssID;
            if (!ssID) return false;
            const trimmed = ssID.toString().trim();
            if (trimmed === '' || trimmed === '.' || trimmed === '-' || trimmed === 'N/A') return false;
            return true;
        }

        // Calculate days between two dates
        function daysBetween(date1, date2) {
            const oneDay = 24 * 60 * 60 * 1000;
            return Math.round(Math.abs((date1 - date2) / oneDay));
        }

        // Parse milestone dates from text
        function parseMilestoneDates(milestoneText) {
            if (!milestoneText) return {};
            
            const dates = {};
            const datePatterns = [
                /Kickoff[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
                /Concept Commit[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
                /Execute Commit[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
                /GA[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i
            ];
            
            const labels = ['kickoff', 'conceptCommit', 'executeCommit', 'ga'];
            
            datePatterns.forEach((pattern, i) => {
                const match = milestoneText.match(pattern);
                if (match) {
                    const dateStr = match[1];
                    const parsedDate = new Date(dateStr);
                    if (!isNaN(parsedDate)) {
                        dates[labels[i]] = parsedDate;
                    }
                }
            });
            
            return dates;
        }

        // Calculate milestone metrics
        function calculateMilestoneMetrics() {
            const metrics = {
                kickoffToConcept: { total: 0, count: 0 },
                conceptToExecute: { total: 0, count: 0 },
                executeToGA: { total: 0, count: 0 },
                kickoffToGA: { total: 0, count: 0 }
            };

            allPrograms.filter(p => hasValidSSID(p)).forEach(program => {
                const dates = parseMilestoneDates(program.milestones);
                
                if (dates.kickoff && dates.conceptCommit) {
                    metrics.kickoffToConcept.total += daysBetween(dates.kickoff, dates.conceptCommit);
                    metrics.kickoffToConcept.count++;
                }
                
                if (dates.conceptCommit && dates.executeCommit) {
                    metrics.conceptToExecute.total += daysBetween(dates.conceptCommit, dates.executeCommit);
                    metrics.conceptToExecute.count++;
                }
                
                if (dates.executeCommit && dates.ga) {
                    metrics.executeToGA.total += daysBetween(dates.executeCommit, dates.ga);
                    metrics.executeToGA.count++;
                }
                
                if (dates.kickoff && dates.ga) {
                    metrics.kickoffToGA.total += daysBetween(dates.kickoff, dates.ga);
                    metrics.kickoffToGA.count++;
                }
            });

            const results = {};
            Object.keys(metrics).forEach(key => {
                if (metrics[key].count > 0) {
                    results[key] = {
                        average: Math.round(metrics[key].total / metrics[key].count),
                        count: metrics[key].count
                    };
                }
            });

            return results;
        }

        // Calculate time to market trends by HPE fiscal quarter
        function calculateTimeToMarketTrends() {
            const trendData = {};
            
            allPrograms.filter(p => hasValidSSID(p)).forEach(p => {
                const milestones = parseMilestoneDates(p.milestones);
                let startDate = milestones.kickoff;
                
                if (!startDate && p.startDate) {
                    startDate = new Date(p.startDate);
                    if (isNaN(startDate)) startDate = null;
                }
                
                if (!startDate) return;
                
                let duration = null;
                
                if (milestones.kickoff && milestones.ga) {
                    duration = daysBetween(milestones.kickoff, milestones.ga);
                } else if (p.startDate && p.finishDate) {
                    const start = new Date(p.startDate);
                    const finish = new Date(p.finishDate);
                    if (!isNaN(start) && !isNaN(finish)) {
                        duration = daysBetween(start, finish);
                    }
                }
                
                if (duration === null || duration < 0) return;
                
                // Calculate HPE fiscal quarter
                // HPE fiscal year: Nov 1 - Oct 31
                // Q1: Nov-Jan, Q2: Feb-Apr, Q3: May-Jul, Q4: Aug-Oct
                // JavaScript months: 0=Jan, 1=Feb, ..., 9=Oct, 10=Nov, 11=Dec
                const month = startDate.getMonth();
                const year = startDate.getFullYear();
                
                let fiscalYear, fiscalQuarter;
                
                if (month >= 10) { // Nov (10), Dec (11)
                    fiscalYear = year + 1;
                    fiscalQuarter = 1;
                } else if (month === 0) { // Jan (0)
                    fiscalYear = year;
                    fiscalQuarter = 1;
                } else if (month >= 1 && month <= 3) { // Feb-Apr (1-3)
                    fiscalYear = year;
                    fiscalQuarter = 2;
                } else if (month >= 4 && month <= 6) { // May-Jul (4-6)
                    fiscalYear = year;
                    fiscalQuarter = 3;
                } else { // Aug-Oct (7-9)
                    fiscalYear = year;
                    fiscalQuarter = 4;
                }
                
                const quarterKey = `FY${fiscalYear} Q${fiscalQuarter}`;
                
                if (!trendData[quarterKey]) {
                    trendData[quarterKey] = {
                        durations: [],
                        startDate: startDate
                    };
                }
                
                trendData[quarterKey].durations.push(duration);
            });
            
            const trends = Object.entries(trendData)
                .map(([quarter, data]) => ({
                    quarter,
                    avgDuration: Math.round(data.durations.reduce((a, b) => a + b, 0) / data.durations.length),
                    count: data.durations.length,
                    startDate: data.startDate
                }))
                .sort((a, b) => a.startDate - b.startDate);
            
            return trends;
        }

        // Generate trend insights
        function generateTrendInsights() {
            const trends = calculateTimeToMarketTrends();
            const insightsDiv = document.getElementById('trendInsights');
            
            if (trends.length === 0) {
                insightsDiv.innerHTML = '<p style="color: #666; text-align: center;">Insufficient data to generate insights. Programs need start dates and durations.</p>';
                return;
            }

            const baselineQuarter = 'FY2025 Q1';
            const baseline = trends.find(q => q.quarter === baselineQuarter);
            const lastQuarter = trends[trends.length - 1];
            
            if (!baseline) {
                insightsDiv.innerHTML = `
                    <div style="padding: 1rem; background: #FFF9E6; border-left: 4px solid #FFA07A; border-radius: 4px;">
                        <strong>Note:</strong> GL Ready baseline quarter (${baselineQuarter}) not found in data. 
                        The analysis requires data from ${baselineQuarter} onwards to show accurate improvement metrics.
                        <br><br>
                        <em>HPE Fiscal Year: Q1 = Nov-Jan, Q2 = Feb-Apr, Q3 = May-Jul, Q4 = Aug-Oct</em>
                    </div>
                `;
                return;
            }
            
            const improvement = Math.round(((baseline.avgDuration - lastQuarter.avgDuration) / baseline.avgDuration) * 100);
            
            const relevantTrends = trends.filter(q => q.startDate >= baseline.startDate);
            const bestQuarter = relevantTrends.reduce((min, q) => q.avgDuration < min.avgDuration ? q : min, relevantTrends[0]);
            
            const programsWithDuration = allPrograms.filter(p => hasValidSSID(p)).map(p => {
                const milestones = parseMilestoneDates(p.milestones);
                let duration = null;
                
                if (milestones.kickoff && milestones.ga) {
                    duration = daysBetween(milestones.kickoff, milestones.ga);
                } else if (p.startDate && p.finishDate) {
                    const start = new Date(p.startDate);
                    const finish = new Date(p.finishDate);
                    if (!isNaN(start) && !isNaN(finish)) {
                        duration = daysBetween(start, finish);
                    }
                }
                
                return { ...p, duration };
            }).filter(p => p.duration !== null && p.duration > 0);
            
            programsWithDuration.sort((a, b) => a.duration - b.duration);
            const fastestPrograms = programsWithDuration.slice(0, 3);
            const slowestPrograms = programsWithDuration.slice(-3).reverse();
            
            let recentTrend = 'stable';
            if (relevantTrends.length >= 4) {
                const recent = relevantTrends.slice(-3).reduce((sum, q) => sum + q.avgDuration, 0) / 3;
                const trendChange = ((baseline.avgDuration - recent) / baseline.avgDuration) * 100;
                if (trendChange > 5) recentTrend = 'improving';
                else if (trendChange < -5) recentTrend = 'declining';
            }
            
            let narrative = '';
            let statusClass = improvement >= 0 ? 'positive' : 'negative';
            
            if (improvement > 15) {
                narrative = `Outstanding progress! Since implementing GL Ready in ${baselineQuarter}, programs are completing <strong>${improvement}% faster</strong>. `;
                narrative += `This demonstrates that the standardized processes, templates, and best practices are significantly accelerating delivery. `;
                narrative += `The best performance, ${bestQuarter.quarter}, achieved an average of just ${bestQuarter.avgDuration} days, setting a benchmark for future programs.`;
            } else if (improvement > 5) {
                narrative = `Positive momentum! Since GL Ready implementation in ${baselineQuarter}, programs are completing <strong>${improvement}% faster</strong>. `;
                narrative += `The standardization is taking hold, though there's opportunity to achieve greater gains by ensuring all teams fully adopt the approach. `;
                narrative += `${bestQuarter.quarter} demonstrated what's possible at ${bestQuarter.avgDuration} days average.`;
            } else if (improvement > -5) {
                narrative = `Since GL Ready implementation in ${baselineQuarter}, program duration has remained <strong>relatively stable</strong> at around ${lastQuarter.avgDuration} days. `;
                narrative += `While standardization hasn't yet produced dramatic time savings, the consistency suggests processes are being followed. `;
                narrative += `Focus on identifying and removing bottlenecks to unlock faster delivery. ${bestQuarter.quarter} showed potential at ${bestQuarter.avgDuration} days.`;
            } else {
                narrative = `Since GL Ready implementation in ${baselineQuarter}, programs are taking <strong>${Math.abs(improvement)}% longer</strong>. `;
                narrative += `This suggests potential process overhead or other factors that need investigation. `;
                narrative += `Review what changed between ${bestQuarter.quarter} (${bestQuarter.avgDuration} days) and recent quarters to identify root causes and adjust the approach.`;
                statusClass = 'negative';
            }
            
            if (fastestPrograms.length > 0) {
                narrative += `<br><br>The fastest programs completed in ${fastestPrograms[0].duration}-${fastestPrograms[fastestPrograms.length-1].duration} days, `;
                narrative += `proving that rapid delivery is achievable when teams leverage the full GL Ready framework.`;
            }
            
            const html = `
<!--                <div class="narrative-box">
                    <h4>Executive Summary</h4>
                    <p>${narrative}</p>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; font-style: italic;">
                        This analysis automatically updates as new programs are added and completed. HPE Fiscal Year: Q1 = Nov-Jan, Q2 = Feb-Apr, Q3 = May-Jul, Q4 = Aug-Oct.
                    </p>
                </div>
-->
                
                <div class="insight-card ${statusClass}">
                    <div class="insight-title">Improvement Since GL Ready Launch</div>
                    <div class="insight-value ${improvement < 0 ? 'negative' : ''}">${improvement > 0 ? '+' : ''}${improvement}%</div>
                    <div class="insight-description">
                        ${improvement >= 0 
                            ? `Programs are ${improvement}% faster from ${baseline.quarter} (${baseline.avgDuration}d) to ${lastQuarter.quarter} (${lastQuarter.avgDuration}d)`
                            : `Programs are ${Math.abs(improvement)}% slower - requires investigation`}
                    </div>
                </div>
                
                <div class="insight-card positive">
                    <div class="insight-title">Best Performance Since Launch</div>
                    <div class="insight-value">${bestQuarter.avgDuration} days</div>
                    <div class="insight-description">
                        ${bestQuarter.quarter} achieved the fastest average with ${bestQuarter.count} programs. 
                        This is the benchmark to match or exceed.
                    </div>
                </div>
                
                <div class="insight-card ${recentTrend === 'improving' ? 'positive' : recentTrend === 'declining' ? 'negative' : 'neutral'}">
                    <div class="insight-title">Recent Trend</div>
                    <div class="insight-value">${recentTrend === 'improving' ? '‚ÜóÔ∏è Improving' : recentTrend === 'declining' ? '‚ÜòÔ∏è Declining' : '‚Üí Stable'}</div>
                    <div class="insight-description">
                        ${recentTrend === 'improving' 
                            ? 'Recent quarters show continued acceleration - keep the momentum!' 
                            : recentTrend === 'declining' 
                            ? 'Recent quarters trending slower - intervention needed'
                            : 'Recent quarters consistent - ready for next improvement phase'}
                    </div>
                </div>
                
                <div class="insight-card positive">
                    <div class="insight-title">Fastest Programs (Examples)</div>
                    <div class="insight-description">
                        <ul class="insight-list">
                            ${fastestPrograms.slice(0, 3).map(p => 
                                `<li><strong>${p.itemName}</strong> - ${p.duration} days (${p.bu})</li>`
                            ).join('')}
                        </ul>
                        These programs demonstrate GL Ready best practices in action.
                    </div>
                </div>
                
                <div class="insight-card negative">
                    <div class="insight-title">Opportunity Areas (Longest Duration)</div>
                    <div class="insight-description">
                        <ul class="insight-list">
                            ${slowestPrograms.slice(0, 3).map(p => 
                                `<li><strong>${p.itemName}</strong> - ${p.duration} days (${p.bu})</li>`
                            ).join('')}
                        </ul>
                        Analyze these for bottlenecks and improvement opportunities.
                    </div>
                </div>
                
                <div class="insight-card neutral">
                    <div class="insight-title">Key Drivers of Success</div>
                    <div class="insight-description">
                        <ul class="insight-list">
                            <li><strong>Standardized templates</strong> reduce planning time</li>
                            <li><strong>Clear milestone checkpoints</strong> maintain momentum</li>
                            <li><strong>Reusable components</strong> accelerate development</li>
                            <li><strong>Cross-BU knowledge sharing</strong> spreads best practices</li>
                        </ul>
                    </div>
                </div>
            `;
            
            insightsDiv.innerHTML = html;
        }

        // Get status color
        function getStatusColor(status) {
            if (!status) return '#45B7D1';
            
            const statusLower = status.toLowerCase();
            
            if (statusLower.includes('completed')) {
                return '#01A982';
            } else if (statusLower.includes('on track')) {
                return '#4ECDC4';
            } else if (statusLower.includes('not started')) {
                return '#FF6B6B';
            } else if (statusLower.includes('started')) {
                return '#FFA07A';
            } else if (statusLower.includes('hold') || statusLower.includes('cancel')) {
                return '#425563';
            } else if (statusLower.includes('not applicable')) {
                return '#45B7D1';
            } else {
                return '#98D8C8';
            }
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            if (!status) return '<span class="status-badge status-na">N/A</span>';
            
            const statusLower = status.toLowerCase();
            let badgeClass = 'status-na';
            
            if (statusLower.includes('completed')) {
                badgeClass = 'status-completed';
            } else if (statusLower.includes('on track')) {
                badgeClass = 'status-ontrack';
            } else if (statusLower.includes('not started')) {
                badgeClass = 'status-notstarted';
            } else if (statusLower.includes('started')) {
                badgeClass = 'status-started';
            } else if (statusLower.includes('hold') || statusLower.includes('cancel')) {
                badgeClass = 'status-onhold';
            }
            
            return `<span class="status-badge ${badgeClass}">${status}</span>`;
        }

        // Render metrics
        function renderMetrics() {
            const validPrograms = allPrograms.filter(p => hasValidSSID(p));
            const totalPrograms = validPrograms.length;
            const completedPrograms = validPrograms.filter(p => 
                p.status && p.status.toLowerCase().includes('completed')
            ).length;
            const activePrograms = validPrograms.filter(p => 
                p.status && (
                    p.status.toLowerCase().includes('started') || 
                    p.status.toLowerCase().includes('on track')
                )
            ).length;

            // Calculate average duration
            let totalDuration = 0;
            let durationCount = 0;
            
            validPrograms.forEach(p => {
                const milestones = parseMilestoneDates(p.milestones);
                if (milestones.kickoff && milestones.ga) {
                    totalDuration += daysBetween(milestones.kickoff, milestones.ga);
                    durationCount++;
                } else if (p.startDate && p.finishDate) {
                    const start = new Date(p.startDate);
                    const finish = new Date(p.finishDate);
                    if (!isNaN(start) && !isNaN(finish)) {
                        totalDuration += daysBetween(start, finish);
                        durationCount++;
                    }
                }
            });
            
            const avgDuration = durationCount > 0 ? Math.round(totalDuration / durationCount) : 0;

            const metricsHtml = `
                <div class="metric-card">
                    <div class="metric-label">Total Programs</div>
                    <div class="metric-value">${totalPrograms}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Completed Programs</div>
                    <div class="metric-value">${completedPrograms}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Programs</div>
                    <div class="metric-value">${activePrograms}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Duration (Days)</div>
                    <div class="metric-value">${avgDuration || 'N/A'}</div>
                </div>
            `;

            document.getElementById('metricsGrid').innerHTML = metricsHtml;
        }

        // Render charts
        function renderCharts() {
            renderStatusChart();
            renderBUChart();
            renderTimeToMarketChart();
            renderTierChart();
            renderTemplateChart();
            renderMilestoneChart();
            renderTrendChart();
            generateTrendInsights();
        }

        function renderStatusChart() {
            const statusCounts = {};
            allPrograms.filter(p => hasValidSSID(p)).forEach(p => {
                const status = p.status || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const statuses = Object.keys(statusCounts);
            const colors = statuses.map(status => getStatusColor(status));

            const ctx = document.getElementById('statusChart').getContext('2d');
            if (charts.status) charts.status.destroy();
            
            charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: statuses,
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 10,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        function renderBUChart() {
            const buCounts = {};
            allPrograms.filter(p => hasValidSSID(p)).forEach(p => {
                const bu = p.bu || 'Unknown';
                buCounts[bu] = (buCounts[bu] || 0) + 1;
            });

            const ctx = document.getElementById('buChart').getContext('2d');
            if (charts.bu) charts.bu.destroy();
            
            charts.bu = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(buCounts),
                    datasets: [{
                        label: 'Programs',
                        data: Object.values(buCounts),
                        backgroundColor: '#01A982',
                        borderColor: '#01A982',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function renderTimeToMarketChart() {
            const buDurations = {};
            
            allPrograms.filter(p => hasValidSSID(p)).forEach(p => {
                const bu = p.bu || 'Unknown';
                const milestones = parseMilestoneDates(p.milestones);
                let duration = null;
                
                if (milestones.kickoff && milestones.ga) {
                    duration = daysBetween(milestones.kickoff, milestones.ga);
                } else if (p.startDate && p.finishDate) {
                    const start = new Date(p.startDate);
                    const finish = new Date(p.finishDate);
                    if (!isNaN(start) && !isNaN(finish)) {
                        duration = daysBetween(start, finish);
                    }
                }
                
                if (duration !== null && duration > 0) {
                    if (!buDurations[bu]) {
                        buDurations[bu] = [];
                    }
                    buDurations[bu].push(duration);
                }
            });

            const buAvgs = {};
            Object.keys(buDurations).forEach(bu => {
                const avg = buDurations[bu].reduce((a, b) => a + b, 0) / buDurations[bu].length;
                buAvgs[bu] = Math.round(avg);
            });

            const ctx = document.getElementById('timeToMarketChart').getContext('2d');
            if (charts.timeToMarket) charts.timeToMarket.destroy();
            
            charts.timeToMarket = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(buAvgs),
                    datasets: [{
                        label: 'Avg Days',
                        data: Object.values(buAvgs),
                        backgroundColor: '#4ECDC4',
                        borderColor: '#4ECDC4',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        }
                    }
                }
            });
        }

        function renderTierChart() {
            const tierCounts = {};
            allPrograms.filter(p => hasValidSSID(p)).forEach(p => {
                const tier = p.tier || 'Unknown';
                tierCounts[tier] = (tierCounts[tier] || 0) + 1;
            });

            const ctx = document.getElementById('tierChart').getContext('2d');
            if (charts.tier) charts.tier.destroy();
            
            charts.tier = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(tierCounts),
                    datasets: [{
                        data: Object.values(tierCounts),
                        backgroundColor: [
                            '#01A982', '#4ECDC4', '#45B7D1', 
                            '#FFA07A', '#FF6B6B', '#98D8C8'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 10,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        function renderTemplateChart() {
            const templateCounts = {};
            allPrograms.filter(p => hasValidSSID(p)).forEach(p => {
                const template = p.template || 'Not Specified';
                templateCounts[template] = (templateCounts[template] || 0) + 1;
            });

            const ctx = document.getElementById('templateChart').getContext('2d');
            if (charts.template) charts.template.destroy();
            
            charts.template = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(templateCounts),
                    datasets: [{
                        data: Object.values(templateCounts),
                        backgroundColor: [
                            '#01A982', '#4ECDC4', '#45B7D1', 
                            '#FFA07A', '#FF6B6B', '#98D8C8',
                            '#B0E57C', '#FF9F40', '#9966FF'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 10,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} programs (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMilestoneChart() {
            const metrics = calculateMilestoneMetrics();
            
            const labels = [];
            const data = [];
            const counts = [];
            
            const phaseLabels = {
                kickoffToConcept: 'Kickoff to Concept Commit',
                conceptToExecute: 'Concept to Execute Commit',
                executeToGA: 'Execute Commit to GA',
                kickoffToGA: 'Kickoff to GA (Total)'
            };
            
            Object.keys(phaseLabels).forEach(key => {
                if (metrics[key]) {
                    labels.push(phaseLabels[key]);
                    data.push(metrics[key].average);
                    counts.push(metrics[key].count);
                }
            });

            if (labels.length === 0) {
                const ctx = document.getElementById('milestoneChart').getContext('2d');
                if (charts.milestone) charts.milestone.destroy();
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No milestone data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const ctx = document.getElementById('milestoneChart').getContext('2d');
            if (charts.milestone) charts.milestone.destroy();
            
            charts.milestone = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Days',
                        data: data,
                        backgroundColor: '#01A982',
                        borderColor: '#01A982',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const index = context.dataIndex;
                                    return [
                                        `Average: ${context.parsed.x} days`,
                                        `Programs: ${counts[index]}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        }
                    }
                }
            });
        }

        function renderTrendChart() {
            const trends = calculateTimeToMarketTrends();
            
            if (trends.length === 0) {
                const ctx = document.getElementById('trendChart').getContext('2d');
                if (charts.trend) charts.trend.destroy();
                
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No trend data available - programs need start dates and durations', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (charts.trend) charts.trend.destroy();
            
            // Calculate trend line
            const n = trends.length;
            const sumX = trends.reduce((sum, _, i) => sum + i, 0);
            const sumY = trends.reduce((sum, t) => sum + t.avgDuration, 0);
            const sumXY = trends.reduce((sum, t, i) => sum + (i * t.avgDuration), 0);
            const sumX2 = trends.reduce((sum, _, i) => sum + (i * i), 0);
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            const trendLine = trends.map((_, i) => Math.round(slope * i + intercept));
            
            const improvement = Math.round(((trends[0].avgDuration - trends[trends.length - 1].avgDuration) / trends[0].avgDuration) * 100);
            
            const glReadyLaunchQuarter = 'FY2025 Q1';
            const glReadyIndex = trends.findIndex(t => t.quarter === glReadyLaunchQuarter);
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trends.map(t => t.quarter),
                    datasets: [
                        {
                            label: 'Average Program Duration',
                            data: trends.map(t => t.avgDuration),
                            borderColor: '#01A982',
                            backgroundColor: 'rgba(1, 169, 130, 0.1)',
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#01A982',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Trend Line',
                            data: trendLine,
                            borderColor: '#425563',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    const item = items[0];
                                    return trends[item.dataIndex].quarter;
                                },
                                label: (context) => {
                                    if (context.datasetIndex === 0) {
                                        const trend = trends[context.dataIndex];
                                        return [
                                            `Average: ${context.parsed.y} days`,
                                            `Programs: ${trend.count}`
                                        ];
                                    } else {
                                        return `Trend: ${context.parsed.y} days`;
                                    }
                                },
                                afterBody: (items) => {
                                    if (items[0].datasetIndex === 0) {
                                        const dataIndex = items[0].dataIndex;
                                        if (dataIndex === 0) {
                                            return '\nStarting baseline';
                                        } else {
                                            const current = trends[dataIndex].avgDuration;
                                            const previous = trends[0].avgDuration;
                                            const change = Math.round(((previous - current) / previous) * 100);
                                            if (change > 0) {
                                                return `\n‚úì ${change}% faster than baseline`;
                                            } else if (change < 0) {
                                                return `\n‚ö† ${Math.abs(change)}% slower than baseline`;
                                            } else {
                                                return '\nNo change from baseline';
                                            }
                                        }
                                    }
                                    return '';
                                }
                            }
                        },
                        subtitle: {
                            display: true,
                            text: improvement > 0 
                                ? `‚úì Programs are ${improvement}% faster - GL Ready standardization is working!`
                                : improvement < 0
                                ? `‚ö† Programs are ${Math.abs(improvement)}% slower - review process efficiency`
                                : 'Program duration stable over time',
                            color: improvement > 0 ? '#2E7D32' : improvement < 0 ? '#E65100' : '#666',
                            font: {
                                size: 13,
                                weight: 'bold'
                            },
                            padding: {
                                top: 5,
                                bottom: 15
                            }
                        },
                        annotation: glReadyIndex >= 0 ? {
                            annotations: {
                                glReadyLaunch: {
                                    type: 'line',
                                    xMin: glReadyIndex,
                                    xMax: glReadyIndex,
                                    borderColor: '#01A982',
                                    borderWidth: 3,
                                    borderDash: [10, 5],
                                    label: {
                                        display: true,
                                        content: 'üöÄ GL Ready Launch',
                                        position: 'start',
                                        backgroundColor: '#01A982',
                                        color: 'white',
                                        font: {
                                            size: 11,
                                            weight: 'bold'
                                        },
                                        padding: 6,
                                        yAdjust: -10
                                    }
                                }
                            }
                        } : {}
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Days to Market'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + 'd';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Quarter'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('programsTableBody');
            tbody.innerHTML = '';

            filteredPrograms.forEach(program => {
                const hasDescription = program.description && program.description.trim();
                const hasMilestones = program.milestones && program.milestones.trim();
                const isExpandable = hasDescription || hasMilestones;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="ssid-cell">${program.ssID || ''}</td>
                    <td>${program.bu || ''}</td>
                    <td class="program-name ${isExpandable ? 'expandable' : ''}" data-program-id="${program.ssID}">
                        ${isExpandable ? '<span class="expand-icon">‚ñ∂</span>' : ''}
                        ${program.itemName || ''}
                    </td>
                    <td>${program.tier ? `<span class="tier-badge">${program.tier}</span>` : ''}</td>
                    <td>${program.template || ''}</td>
                    <td>${program.nsi || ''}</td>
                    <td>${program.productManager || ''}</td>
                    <td>${program.programManager || ''}</td>
                    <td>${program.e2eLead || ''}</td>
                    <td class="link-cell">${formatProjectLink(program.projectPlanUrl, program.projectPlanText)}</td>
                    <td>${getStatusBadge(program.status)}</td>
                `;
                tbody.appendChild(row);

                if (isExpandable) {
                    row.querySelector('.program-name').addEventListener('click', () => {
                        toggleDetailRow(program.ssID);
                    });
                }
            });
        }

        function formatProjectLink(url, text) {
            if (!url) return '';
            
            // Use provided text, or fall back to URL
            const linkText = text || url;
            
            // Ensure URL is valid
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return `<a href="${url}" target="_blank">${linkText}</a>`;
            }
            
            // If not a valid URL, return as plain text
            return linkText;
        }

        function toggleDetailRow(programId) {
            const tbody = document.getElementById('programsTableBody');
            const rows = tbody.querySelectorAll('tr');
            let programRow = null;
            
            rows.forEach(row => {
                const nameCell = row.querySelector('.program-name');
                if (nameCell && nameCell.dataset.programId === programId) {
                    programRow = row;
                }
            });

            if (!programRow) return;

            const existingDetailRow = programRow.nextElementSibling;
            const expandIcon = programRow.querySelector('.expand-icon');

            if (existingDetailRow && existingDetailRow.classList.contains('detail-row')) {
                existingDetailRow.remove();
                if (expandIcon) expandIcon.classList.remove('expanded');
                return;
            }

            const program = allPrograms.find(p => p.ssID === programId);
            if (!program) return;

            const detailRow = document.createElement('tr');
            detailRow.classList.add('detail-row');
            
            let detailContent = '';
            
            if (program.description && program.description.trim()) {
                detailContent += `
                    <div class="detail-description">
                        <strong>Description:</strong><br>
                        ${program.description}
                    </div>
                `;
            }
            
            if (program.milestones && program.milestones.trim()) {
                detailContent += `
                    <div class="detail-milestones">
                        <strong>Milestones:</strong><br>
                        ${program.milestones}
                    </div>
                `;
            }

            detailRow.innerHTML = `
                <td colspan="11" class="detail-cell">
                    <div class="detail-content">
                        ${detailContent}
                    </div>
                </td>
            `;

            programRow.after(detailRow);
            if (expandIcon) expandIcon.classList.add('expanded');
        }

        // Search and filter
        function renderFilters() {
            const statuses = [...new Set(allPrograms.filter(p => hasValidSSID(p)).map(p => p.status).filter(s => s))];
            const businessUnits = [...new Set(allPrograms.filter(p => hasValidSSID(p)).map(p => p.bu).filter(bu => bu))];
            const filterTags = document.getElementById('filterTags');
            
            const html = `
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <strong style="font-size: 0.85rem; color: var(--hpe-gray); min-width: 120px;">Adoption Status:</strong>
                        <div class="filter-tag active" data-filter-type="status" data-filter="all">All Statuses</div>
                        ${statuses.map(s => `
                            <div class="filter-tag" data-filter-type="status" data-filter="${s}">${s}</div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        <strong style="font-size: 0.85rem; color: var(--hpe-gray); min-width: 120px;">Business Unit:</strong>
                        <div class="filter-tag active" data-filter-type="bu" data-filter="all">All BUs</div>
                        ${businessUnits.map(bu => `
                            <div class="filter-tag" data-filter-type="bu" data-filter="${bu}">${bu}</div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            filterTags.innerHTML = html;
            
            filterTags.querySelectorAll('.filter-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    const filterType = tag.dataset.filterType;
                    const filterValue = tag.dataset.filter;
                    
                    // Remove active from same filter type
                    filterTags.querySelectorAll(`.filter-tag[data-filter-type="${filterType}"]`).forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    
                    // Update appropriate filter
                    if (filterType === 'status') {
                        currentStatusFilter = filterValue;
                    } else if (filterType === 'bu') {
                        currentBUFilter = filterValue;
                    }
                    
                    applyFilters();
                });
            });
        }

        // Initialize filter toggle functionality
        function initializeFilterToggle() {
            const toggleBtn = document.getElementById('filterToggleBtn');
            const filterContent = document.getElementById('filterContent');
            const filterArrow = toggleBtn.querySelector('.filter-arrow');
            
            toggleBtn.addEventListener('click', () => {
                const isExpanded = filterContent.classList.contains('expanded');
                
                if (isExpanded) {
                    // Collapse
                    filterContent.classList.remove('expanded');
                    filterArrow.classList.remove('expanded');
                } else {
                    // Expand
                    filterContent.classList.add('expanded');
                    filterArrow.classList.add('expanded');
                }
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredPrograms = allPrograms.filter(p => {
                if (!hasValidSSID(p)) return false;
                
                // Apply status filter
                if (currentStatusFilter !== 'all' && p.status !== currentStatusFilter) {
                    return false;
                }
                
                // Apply BU filter
                if (currentBUFilter !== 'all' && p.bu !== currentBUFilter) {
                    return false;
                }
                
                // Apply search filter
                if (searchTerm) {
                    const searchableText = [
                        p.ssID, 
                        p.status,
                        p.bu, 
                        p.itemName, 
                        p.tier, 
                        p.template,
                        p.nsi,
                        p.productManager, 
                        p.programManager, 
                        p.e2eLead,
                        p.description,
                        p.milestones,
                        p.projectPlanText,
                        p.projectPlanUrl
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            if (currentSort.column) {
                sortTable(currentSort.column, currentSort.type, currentSort.direction);
            } else {
                renderTable();
            }
        }

        // Table sorting
        function initializeTableSorting() {
            document.querySelectorAll('th.sortable').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.classList.contains('resize-handle')) return;
                    
                    const column = header.dataset.column;
                    const type = header.dataset.type;
                    
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    
                    sortTable(column, type, currentSort.direction);
                    updateSortIndicators(column, currentSort.direction);
                });
            });
        }

        function sortTable(column, type, direction) {
            filteredPrograms.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (type === 'number') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    aVal = aVal.toString().toLowerCase();
                    bVal = bVal.toString().toLowerCase();
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderTable();
        }

        function updateSortIndicators(activeColumn, direction) {
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '';
            });
            
            const activeHeader = document.querySelector(`th[data-column="${activeColumn}"]`);
            if (activeHeader) {
                const indicator = activeHeader.querySelector('.sort-indicator');
                indicator.textContent = direction === 'asc' ? '‚ñ≤' : '‚ñº';
            }
        }

        // Column resizing
        function initializeColumnResizing() {
            const handles = document.querySelectorAll('.resize-handle');
            let isResizing = false;
            let currentHandle = null;
            let startX = 0;
            let startWidth = 0;

            handles.forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    currentHandle = handle;
                    startX = e.pageX;
                    const th = handle.parentElement;
                    startWidth = th.offsetWidth;
                    th.classList.add('resizing');
                    handle.classList.add('active');
                    e.preventDefault();
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const diff = e.pageX - startX;
                const th = currentHandle.parentElement;
                const newWidth = Math.max(50, startWidth + diff);
                th.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    if (currentHandle) {
                        currentHandle.parentElement.classList.remove('resizing');
                        currentHandle.classList.remove('active');
                        currentHandle = null;
                    }
                }
            });
        }

        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Fetch data from proxy
                allPrograms = await fetchSmartsheetData();
                filteredPrograms = allPrograms.filter(p => hasValidSSID(p));

                // Hide loading, show dashboard
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

                // Update last updated time
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

                // Render all components
                renderMetrics();
                renderCharts();
                renderFilters();
                renderTable();

                // Initialize interactions
                initializeFilterToggle();
                initializeTableSorting();
                initializeColumnResizing();

                // Search functionality
                document.getElementById('searchInput').addEventListener('input', applyFilters);

            } catch (error) {
                console.error('Dashboard initialization error:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                
                const errorContainer = document.getElementById('errorContainer');
                errorContainer.style.display = 'block';
                errorContainer.innerHTML = `
                    <div class="error">
                        <h3>‚ö†Ô∏è Error Loading Dashboard</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Troubleshooting Steps:</strong></p>
                        <ol>
                            <li><strong>Is the proxy server running?</strong>
                                <ul>
                                    <li>Open a separate terminal/command prompt</li>
                                    <li>Navigate to your dashboard folder</li>
                                    <li>Run: <code>node smartsheet-proxy.js</code></li>
                                    <li>You should see: "‚úÖ Smartsheet proxy server running..."</li>
                                </ul>
                            </li>
                            <li><strong>Did you configure the proxy?</strong>
                                <ul>
                                    <li>Open <code>smartsheet-proxy.js</code> in a text editor</li>
                                    <li>Edit lines 7-8 with your Smartsheet token and Sheet ID</li>
                                    <li>Save the file and restart: <code>node smartsheet-proxy.js</code></li>
                                </ul>
                            </li>
                            <li><strong>Check browser console (F12)</strong> for detailed error messages</li>
                            <li><strong>Verify proxy URL</strong> is <code>http://localhost:3000/api/sheet</code></li>
                        </ol>
                        <p><strong>Expected Setup:</strong></p>
                        <ul>
                            <li>Terminal 1: <code>node smartsheet-proxy.js</code> (running)</li>
                            <li>Terminal 2: <code>http-server -p 8000</code> (running)</li>
                            <li>Browser: <code>http://localhost:8000/hpe_dashboard_smartsheet.html</code></li>
                        </ul>
                    </div>
                `;
            }
        }

        // Start the dashboard when page loads
        window.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
